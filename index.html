<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Vinilo para Coches</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(to right, #f4f4f4, #e0e0e0);
      max-width: 960px;
      margin: auto;
      padding: 30px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    header img {
      height: 60px;
    }
    h2 { color: #333; }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 20px;
      padding: 12px 25px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover { background-color: #388e3c; }
    .resultado {
      margin-top: 30px;
      padding: 20px;
      background-color: #ffffff;
      border-left: 5px solid #4CAF50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 600px) {
      .two-columns { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <img src="img/oracal.png" alt="Oracal logo">
    <img src="img/totenser.jpg" alt="Totensur logo">
  </header>

  <h2>Calculadora de Presupuesto para Vinilización de Vehículos</h2>

  <div class="section">
    <h3>Datos del Vehículo</h3>
    <div class="two-columns">
      <div>
        <label for="marca">Marca:</label>
        <select id="marca" onchange="cargarModelos()">
          <option value="">-- Selecciona marca --</option>
        </select>
      </div>
      <div>
        <label for="modelo">Modelo:</label>
        <select id="modelo">
          <option value="">-- Selecciona modelo --</option>
        </select>
      </div>
    </div>
    <div class="two-columns">
      <div>
        <label for="anio">Año del vehículo:</label>
        <input type="number" id="anio" min="1990" max="2025" value="2020">
      </div>
      <div>
        <label for="tipoVinil">Tipo de vinilo:</label>
        <select id="tipoVinil">
          <option value="standard">Vinilo estándar (€15/m²)</option>
          <option value="premium">Vinilo premium (€25/m²)</option>
          <option value="cambioColor">Cambio de color (€30/m²)</option>
          <option value="personalizado">Personalizado (€35/m²)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Parámetros de Trabajo</h3>
    <div class="two-columns">
      <div>
        <label for="factorComplejidad">Factor de complejidad:</label>
        <select id="factorComplejidad">
          <option value="1.0">Simple (1.0)</option>
          <option value="1.2" selected>Estándar (1.2)</option>
          <option value="1.5">Complejo (1.5)</option>
          <option value="2.0">Muy complejo (2.0)</option>
        </select>
      </div>
      <div>
        <label for="horasTrabajo">Horas estimadas de trabajo:</label>
        <input type="number" id="horasTrabajo" min="1" max="100" value="20">
      </div>
    </div>
    <div class="two-columns">
      <div>
        <label for="tarifaHora">Tarifa por hora (€):</label>
        <input type="number" id="tarifaHora" step="0.5" value="30">
      </div>
      <div>
        <label for="anchoVinilo">Ancho del vinilo (metros):</label>
        <input type="number" id="anchoVinilo" step="0.01" value="1.52">
      </div>
    </div>
  </div>

  <button onclick="calcularPresupuesto()">Calcular Presupuesto</button>

  <div class="resultado" id="resultado">
    <h3>Resultado del Presupuesto</h3>
    <p>Selecciona un vehículo y completa los parámetros para calcular.</p>
  </div>

  <script>
    let baseDeDatos = {};

    fetch('vehiculos_combinado_convertido.json')
      .then(res => res.json())
      .then(data => {
        baseDeDatos = agruparPorMarcaYModelo(data);
        cargarMarcas();
      });

    function agruparPorMarcaYModelo(lista) {
      const datos = {};
      for (const item of lista) {
        const marca = item.marca?.trim();
        const modelo = item.modelo?.trim();
        if (!marca || !modelo || !item.largo || !item.ancho || !item.alto) continue;
        if (!datos[marca]) datos[marca] = {};
        datos[marca][modelo] = {
          largo: parseFloat(item.largo),
          ancho: parseFloat(item.ancho),
          alto: parseFloat(item.alto)
        };
      }
      return datos;
    }

    function cargarMarcas() {
      const marcaSelect = document.getElementById('marca');
      marcaSelect.innerHTML = '<option value="">-- Selecciona marca --</option>';
      Object.keys(baseDeDatos).forEach(marca => {
        const option = document.createElement('option');
        option.value = marca;
        option.textContent = marca;
        marcaSelect.appendChild(option);
      });
    }

    function cargarModelos() {
      const marca = document.getElementById('marca').value;
      const modeloSelect = document.getElementById('modelo');
      modeloSelect.innerHTML = '<option value="">-- Selecciona modelo --</option>';
      if (baseDeDatos[marca]) {
        Object.keys(baseDeDatos[marca]).forEach(modelo => {
          const option = document.createElement('option');
          option.value = modelo;
          option.textContent = modelo;
          modeloSelect.appendChild(option);
        });
      }
    }

    function calcularPresupuesto() {
      const marca = document.getElementById('marca').value;
      const modelo = document.getElementById('modelo').value;
      const tipoVinil = document.getElementById('tipoVinil').value;
      const factor = parseFloat(document.getElementById('factorComplejidad').value);
      const horas = parseFloat(document.getElementById('horasTrabajo').value);
      const tarifa = parseFloat(document.getElementById('tarifaHora').value);
      const anchoVinilo = parseFloat(document.getElementById('anchoVinilo').value);

      if (!marca || !modelo || !baseDeDatos[marca]?.[modelo]) {
        alert('Selecciona una marca y modelo válidos.');
        return;
      }

      const { largo, ancho, alto } = baseDeDatos[marca][modelo];
      const areaSuperficial = 0.8 * (2 * (largo * alto + ancho * alto) + largo * ancho);
      const areaVinilo = areaSuperficial * factor;
      const metrosLineales = areaVinilo / anchoVinilo;

      const precios = { standard: 15, premium: 25, cambioColor: 30, personalizado: 35 };
      const precioM2 = precios[tipoVinil];
      const costeMaterial = areaVinilo * precioM2;
      const costeManoObra = horas * tarifa;
      const total = costeMaterial + costeManoObra;

      document.getElementById('resultado').innerHTML = `
        <h3>Resultado del Presupuesto</h3>
        <p><strong>Vehículo:</strong> ${marca} ${modelo}</p>
        <div class="two-columns">
          <div>
            <h4>Medidas:</h4>
            <p>Largo: ${largo.toFixed(2)} m</p>
            <p>Ancho: ${ancho.toFixed(2)} m</p>
            <p>Alto: ${alto.toFixed(2)} m</p>
            <p>Área estimada: ${areaSuperficial.toFixed(2)} m²</p>
          </div>
          <div>
            <h4>Vinilo:</h4>
            <p>Tipo: ${document.getElementById('tipoVinil').selectedOptions[0].text}</p>
            <p>Área necesaria: ${areaVinilo.toFixed(2)} m²</p>
            <p>Metros lineales: ${metrosLineales.toFixed(2)} m</p>
          </div>
        </div>
        <div class="two-columns">
          <div>
            <h4>Costes:</h4>
            <p>Material: ${costeMaterial.toFixed(2)} €</p>
            <p>Mano de obra: ${costeManoObra.toFixed(2)} €</p>
            <p><strong>Total:</strong> ${total.toFixed(2)} €</p>
          </div>
          <div>
            <h4>Otros:</h4>
            <p>Precio m²: ${precioM2} €</p>
            <p>Complejidad: ${factor}</p>
            <p>Tarifa/hora: ${tarifa} €</p>
          </div>
        </div>
        <p><em>Nota: estimación orientativa.</em></p>
      `;
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('✅ SW registrado', reg))
          .catch(err => console.warn('❌ Error SW', err));
      });
    }
  </script>
</body>
</html>
